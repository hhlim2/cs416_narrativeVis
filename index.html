<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS416 Narrative Visualization - hhlim2</title>

  
    <input type="range" id="yearSlider" min="2004" max="2010" step="1" value="2004">
    <label id="yearLabel" for="yearSlider">Selected Year: 2004</label>
</head>
<body>
    <div class="word-list" id="word-list"></div>
    <div class="chart" id="chart"></div>

    <script src="https://d3js.org/d3.v5.min.js"></script>

    <script>
        const slider = d3.select("#yearSlider");
        const yearLabel = d3.select("#yearLabel");
        var year = 2004
  
        displayPlot(year)

        //Set up slider and update plot if changed.=
        slider.on("input", function() {
            year = +this.value;
            yearLabel.text('Selected Year:' + year);
            displayPlot(year)
            });
 
        //Funcation to update the plot when a new category is selected
        function displayPlot(year) {
            // Clear the existing plot
            d3.select("#chart").selectAll("*").remove();

            // script.js

        // Load both CSV data files and create the chart
        Promise.all([
            d3.csv('Adult Obesity Rate.csv'),
            d3.csv('Physical Inactivity Rate.csv')
            ]).then(function(files) {
                const obesity = files[0];
                const inactivity = files[1];

            // Convert year and value to appropriate types
            obesity.forEach(d => {
                d.year = +d.year_2;
                d.value = +d.Numerator / d.Denominator * 100;
                d.state = +d.State;
            });

            const filteredObesity = obesity.filter(d => d.year === year);
            inactivity.forEach(d => {
                d.year = +d.year_2;
                d.value = +d.Numerator / d.Denominator * 100;
                d.state = +d.State;
            });
            const filteredInactivity = inactivity.filter(d => d.year === year);
            console.log(filteredInactivity)


            // Combine data into a single array with categories
            const combinedData = [];
            filteredObesity.forEach((d, i) => {
                combinedData.push({year: d.year, category: 'Adult Obesity', value: d.value});
                combinedData.push({year: inactivity[i].year, category: 'Physical Inactivity', value: filteredInactivity[i].value});
            });

            // Set up dimensions for the chart
            const margin = { top: 40, right: 30, bottom: 70, left: 40 };
            const width = 2*(800 - margin.left - margin.right);
            const height = 500 - margin.top - margin.bottom;

            // Create SVG element
            const svg = d3.select("#chart")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // Define scales
            const x0 = d3.scaleBand()
                .domain(filteredObesity.map(d => d.State))
                .rangeRound([0, width])
                .paddingInner(0.1);

            const x1 = d3.scaleBand()
                .domain(['Adult Obesity', 'Physical Inactivity'])
                .rangeRound([0, x0.bandwidth()])
                .padding(0.05);

            const yScale = d3.scaleLinear()
                .domain([0, 100])
                .nice()
                .range([height, 0]);
            
            //color bars
            const color = d3.scaleOrdinal()
                .domain(['Adult Obesity', 'Physical Inactivity'])
                .range(['steelblue', 'darkorange']);

            //draw bar chart
            svg.selectAll("g")
                .data(filteredObesity)
                .enter().append("g")
                .attr("transform", d => `translate(${x0(d.State)},0)`)
                .selectAll("rect")
                .data(d => [
                    {category: 'Adult Obesity', value: d.value, state: d.State},
                    {category: 'Physical Inactivity', value: filteredInactivity.find(e => e.year === d.year).value, state: d.State}
                    
                ])
                .enter().append("rect")
                .attr("x", d => x1(d.category))
                .attr("y", d => yScale(d.value))
                .attr("width", x1.bandwidth())
                .attr("height", d => height - yScale(d.value))
                .attr("fill", d => color(d.category))
                // show tooltip on mouseover
                .on("mouseover", function(event, d) {
             
                const tooltip = d3.select("#tooltip").append("div");
                    tooltip.style("visibility", "visible")
                    .style("left", (d3.event.pageX) + "px").style("top", (d3.event.pageY) + "px"); })
                    .on('mouseover', (d, i) => {  tooltip.transition().duration(200).style("opacity", .9);      
                    tooltip.html(d.state + ' ' + d.category +  ':' + String(d.value).slice(0,4) + '%')
                    console.log(d)
                    })
                    .on('mouseout', d => {
                    tooltip.transition() .duration(500) .style("opacity", 0);
                    });

                    
          
                    // Tooltip div
                    const tooltip = d3.select("body").append("div")
                        .attr("class", "tooltip")
                        .style("opacity", 0);

            // Add x-axis with rotated labels
            svg.append("g")
                .attr("class", "x-axis")
                .attr("transform", `translate(0, ${height})`)
                .call(d3.axisBottom(x0))
                .selectAll("text")
                .style("text-anchor", "end")
                .attr("dx", "-0.8em")
                .attr("dy", "0.15em")
                .attr("transform", "rotate(-45)");

            // Add y-axis
            svg.append("g")
                .attr("class", "y-axis")
                .call(d3.axisLeft(yScale));


            // Add chart title
            svg.append("text")
                .attr("x", width / 2)
                .attr("y", 0 - (margin.top / 2))
                .attr("text-anchor", "middle")
                .style("font-size", "16px")
                .text(`Adult Obesity Rate and Physical Inactivity Rate By State Per Year`);
        });


            
        }
    </script>

    

</body>
</html>
