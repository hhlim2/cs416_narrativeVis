<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS416 Narrative Visualization - hhlim2</title>

  
    <input type="range" id="yearSlider" min="2004" max="2010" step="1" value="2004">
    <label id="yearLabel" for="yearSlider">Selected Year: 2004</label>
</head>
<body>
    <div class="chart" id="chart"></div>

    <script src="https://d3js.org/d3.v5.min.js"></script>

    <script>
        const slider = d3.select("#yearSlider");
        const yearLabel = d3.select("#yearLabel");
        var year = 2004
  
        displayPlot(year)

        //Set up slider and update plot if changed.
        slider.on("input", function() {
            year = +this.value;
            yearLabel.text('Selected Year:' + year);
            displayPlot(year)
            });
 
        //Function to update the plot when a new category is selected
        function displayPlot(year) {
            // Clear the existing plot
            d3.select("#chart").selectAll("*").remove();

            // Load csv files
            Promise.all([
                d3.csv('Adult Obesity Rate.csv'),
                d3.csv('Physical Inactivity Rate.csv')
                ]).then(function(files) {
                    const obesity = files[0];
                    const inactivity = files[1];

            // retrieve year, value, and state from csv
            obesity.forEach(d => {
                d.year = +d.year_2;
                d.value = +d.Numerator / d.Denominator * 100;
                d.state = +d.State;
            });
            //filter data on chosen year
            const filteredObesity = obesity.filter(d => d.year === year);
            
            // retrieve year, value, and state from csv
            inactivity.forEach(d => {
                d.year = +d.year_2;
                d.value = +d.Numerator / d.Denominator * 100;
                d.state = +d.State;
            });
            //filter data on chosen year
            const filteredInactivity = inactivity.filter(d => d.year === year);

            //check to ensure that data is being filtered correctly
            console.log(filteredInactivity)


            // combine data into a single array with category, value, and state
            // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/push
            const combinedData = [];
            filteredObesity.forEach((d, i) => {
                combinedData.push.call({year: d.year, category: 'Adult Obesity', value: d.value, state : d.state});
                combinedData.push.call({year: inactivity[i].year, category: 'Physical Inactivity', value: filteredInactivity[i].value , state : d.state});
            });




            // set up dimensions for the chart / margins
            const margin = { top: 40, right: 40, bottom: 40, left: 40 };
            const width = 2*(800 - margin.left - margin.right);
            const height = 500 - margin.top - margin.bottom;

            // create SVG element for plot
            const svg = d3.select("#chart")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // define x and y axes
            const x0 = d3.scaleBand()
                .domain(filteredObesity.map(d => d.State))
                .rangeRound([0, width])
                .paddingInner(0.1);

            const x1 = d3.scaleBand()
                .domain(['Adult Obesity', 'Physical Inactivity'])
                .rangeRound([0, x0.bandwidth()])
                .padding(0.05);

            const yScale = d3.scaleLinear()
                .domain([0, 100])
                .nice()
                .range([height, 0]);
            
            //set up bar color (UIUC colors just for fun :))
            const color = d3.scaleOrdinal()
                .domain(['Adult Obesity', 'Physical Inactivity'])
                .range(['blue', 'orange']);


            //draw bar chart
            //https://d3-graph-gallery.com/graph/barplot_grouped_basicWide.html
            svg.selectAll("g")
                .data(filteredObesity)
                .enter().append("g")
                .attr("transform", d => `translate(${x0(d.State)},0)`)
                .selectAll("rect")
                .data(d => [
                    {category: 'Adult Obesity', value: d.value, state: d.State},
                    {category: 'Physical Inactivity', value: filteredInactivity.find(e => e.year === d.year).value, state: d.State}
                    
                ])
                .enter().append("rect")
                .attr("x", d => x1(d.category))
                .attr("y", d => yScale(d.value))
                .attr("width", x1.bandwidth())
                .attr("height", d => height - yScale(d.value))
                .attr("fill", d => color(d.category))
                // add tooltip function on  mouseover
                .on("mouseover", function(event, d) {
             
                const tooltip = d3.select("#tooltip").append("div");
                    tooltip.style("visibility", "visible")
                    .style("left", (d3.event.pageX) + "px").style("top", (d3.event.pageY) + "px"); })
                    .on('mouseover', (d, i) => {  tooltip.transition().duration(200).style("opacity", .9);      
                    tooltip.html(d.state + ' ' + d.category +  ':' + String(d.value).slice(0,4) + '%')
                    console.log(d)
                    })
                    .on('mouseout', d => {
                    tooltip.transition() .duration(500) .style("opacity", 0);
                    });

                    // Tooltip div
                    const tooltip = d3.select("body").append("div")
                        .attr("class", "tooltip")
                        .style("opacity", 0);




            // setup x-axis with rotated labels
            //https://stackoverflow.com/questions/11252753/rotate-x-axis-text-in-d3
            svg.append("g")
                    .attr("class", "x-axis")
                    .attr("transform", `translate(0, ${height})`)
                    .call(d3.axisBottom(x0))
                    .selectAll("text")  
                    .style("text-anchor", "end")
                    .attr("dx", "-.8em")
                    .attr("dy", ".15em")
                    .attr("transform", "rotate(-65)");

            // setup y-axis
            svg.append("g")
                .attr("class", "y-axis")
                .call(d3.axisLeft(yScale));


            // add chart title
            svg.append("text")
                .attr("x", width / 2)
                .attr("y", 0 - (margin.top / 2))
                .attr("text-anchor", "middle")
                .style("font-size", "16px")
                .text(`Adult Obesity Rate and Physical Inactivity Rate By State Per Year`);


            // setup legend
            const legend = svg.selectAll(".legend")
                .data(['Adult Obesity', 'Physical Inactivity'])
                .enter().append("g")
                .attr("class", "legend")
                .attr("transform", (d, i) => `translate(0,${i * 20})`);

            legend.append("rect")
                .attr("x", width - 18)
                .attr("width", 18)
                .attr("height", 18)
                .style("fill", color);

            legend.append("text")
                .attr("x", width - 24)
                .attr("y", 9)
                .attr("dy", ".35em")
                .style("text-anchor", "end")
                .text(d => d);
                });


            
        }
    </script>

    

</body>
</html>
